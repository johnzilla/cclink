# Milestone v1.1: Security Hardening & Code Review Fixes

**Status:** SHIPPED 2026-02-22
**Phases:** 6-10
**Total Plans:** 9

## Overview

Address all findings from external code review: fix security gaps (signed metadata, key permissions, PIN-protected handoffs), resolve functional discrepancies (CLI flag conflicts, help text), improve code quality (structured errors, dead code removal, transport optimization), fix homeserver transport API issues, and replace homeserver transport with direct PKARR Mainline DHT publishing. Additionally encrypt all sensitive metadata (hostname, project path) into the blob to prevent DHT metadata leakage.

## Phases

### Phase 6: Signed Record Format

**Goal**: Handoff records are cryptographically honest -- burn and recipient intent is signed into the payload and key permissions are enforced by cclink itself
**Depends on**: Phase 5 (v1.0 complete)
**Requirements**: SEC-01, SEC-02
**Plans**: 2 plans

Plans:
- [x] 06-01: Sign burn and recipient into HandoffRecordSignable (TDD)
- [x] 06-02: Enforce 0600 key file permissions on load and write (TDD)

### Phase 7: Code Quality and Transport

**Goal**: The codebase is clean -- no dead error variants, no stringly-typed 404 detection, no duplicated utilities, and the homeserver client reuses sessions for efficient transport
**Depends on**: Phase 6
**Requirements**: QUAL-01, QUAL-02, QUAL-03, QUAL-04, FUNC-03
**Plans**: 2 plans

Plans:
- [x] 07-01: Error cleanup, shared utilities, structured 404 handling
- [x] 07-02: Lazy signin and list optimization

### Phase 8: CLI Fixes and Documentation

**Goal**: The CLI surface is correct and honest -- flag combinations that cannot work are rejected at parse time, help text shows valid commands, and the PRD reflects actual filesystem paths
**Depends on**: Phase 7
**Requirements**: FUNC-01, FUNC-02, DOCS-01
**Plans**: 1 plan

Plans:
- [x] 08-01: CLI flag mutual exclusion, self-publish help text fix, PRD path cleanup

### Phase 9: PIN-Protected Handoffs

**Goal**: Users can protect a handoff with a PIN so only the recipient who knows the PIN can decrypt the session ID
**Depends on**: Phase 8
**Requirements**: SEC-03
**Plans**: 2 plans

Plans:
- [x] 09-01: PIN key derivation with Argon2id+HKDF and pin_salt record field (TDD)
- [x] 09-02: CLI --pin flag, publish/pickup flow integration, integration tests

### Phase 10: Pubky Homeserver Transport Fix

**Goal**: The transport layer works correctly against the real Pubky homeserver API -- Host header identifies tenants, signup flow handles first-time users, and all CRUD operations succeed
**Depends on**: Phase 9
**Requirements**: FUNC-04
**Plans**: 2 plans

Plans:
- [x] 10-01: Host header on all requests, signup fallback, cross-user URL fix
- [x] 10-02: Update command callers, harden list parsing, full test suite

---

## Milestone Summary

**Key Decisions:**
- Clean break on signed metadata -- no v1/v2 version negotiation (v1.0 records expire via TTL)
- --burn + --share mutually exclusive (CLI error, not silent skip)
- PIN mode implemented as real feature (earlier deferral reversed)
- Argon2id (t=3, m=64MB, p=1) + HKDF-SHA256 for PIN key derivation
- --pin conflicts_with --share (not --burn): --pin + --burn is valid combination
- CclinkError::RecordNotFound carries no payload -- context added by anyhow at call site
- Dead CclinkError variants removed immediately (private binary crate)
- Replaced homeserver transport with PKARR Mainline DHT (no accounts, no tokens)
- Encrypted all sensitive metadata (hostname, project path, session ID) into blob -- no cleartext metadata on DHT
- skip_serializing_if on HandoffRecord default/empty fields to fit 912-byte SignedPacket budget

**Issues Resolved:**
- Burn/recipient tampering now detectable via signed envelope
- Key file permissions enforced at load time (not just delegated to pkarr)
- human_duration duplication eliminated
- 5 dead CclinkError variants removed
- String-matching 404 detection replaced with typed errors
- QR code shows correct pickup command (was showing raw token)
- PRD paths corrected from ~/.cclink/ to ~/.pubky/
- Homeserver transport API issues (Host header, signup flow, URI parsing)
- Metadata leakage: hostname and project path no longer visible in cleartext on DHT

**Issues Deferred:**
- QR code content wrong when --share + --qr combined (minor, not in v1.1 scope)
- Cargo.toml/install.sh placeholder `user/cclink` repo path
- --project flag override (deferred from v1.0)

**Technical Debt Incurred:**
- LatestPointer struct is dead code (#[allow(dead_code)]) after DHT migration
- Age ciphertext size is non-deterministic (324-447 bytes for 99-byte payload); budget relies on skip_serializing_if for headroom

---

_For current project status, see .planning/ROADMAP.md_
