---
phase: 11-prerequisites
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration_round_trip.rs
  - tests/plaintext_leak.rs
  - Cargo.toml
  - src/cli.rs
  - src/commands/init.rs
  - src/commands/pickup.rs
  - src/commands/publish.rs
  - src/commands/revoke.rs
  - src/crypto/mod.rs
  - src/keys/store.rs
  - src/record/mod.rs
  - src/session/mod.rs
  - src/transport/mod.rs
autonomous: true
requirements:
  - CI-01
  - DEP-01

must_haves:
  truths:
    - "cargo clippy --all-targets -- -D warnings exits 0 with no warnings"
    - "cargo fmt --check exits 0 on all source files"
    - "ed25519-dalek exact pin has a TOML comment explaining the pkarr 5.0.3 constraint"
  artifacts:
    - path: "tests/integration_round_trip.rs"
      provides: "Inner doc comments (//!) for file-level documentation"
      contains: "//! Integration tests"
    - path: "tests/plaintext_leak.rs"
      provides: "Inner doc comments (//!) for file-level documentation"
      contains: "//! Plaintext leak"
    - path: "Cargo.toml"
      provides: "Comment documenting ed25519-dalek pre-release pin constraint"
      contains: "pkarr 5.0.3 requires ed25519-dalek"
  key_links:
    - from: "tests/integration_round_trip.rs"
      to: "clippy empty-line-after-doc-comments lint"
      via: "//! inner doc comments instead of /// outer doc comments at file level"
      pattern: "^//!"
    - from: "tests/plaintext_leak.rs"
      to: "clippy empty-line-after-doc-comments lint"
      via: "//! inner doc comments instead of /// outer doc comments at file level"
      pattern: "^//!"
---

<objective>
Fix clippy warnings in test files, apply rustfmt to the entire codebase, and document the ed25519-dalek pre-release pin constraint in Cargo.toml.

Purpose: Establish a clean baseline where `cargo clippy --all-targets -- -D warnings` and `cargo fmt --check` both pass, so Phase 12 can add CI enforcement gates without day-one failures. Also satisfy DEP-01 by documenting the ed25519-dalek constraint for future maintainers.

Output: All Rust source files formatted, test file doc-comment lint resolved, Cargo.toml annotated.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-prerequisites/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix clippy doc-comment lint and add ed25519-dalek pin documentation</name>
  <files>
    tests/integration_round_trip.rs
    tests/plaintext_leak.rs
    Cargo.toml
  </files>
  <action>
Fix the clippy `empty-line-after-doc-comments` lint in two test files by converting file-level `///` outer doc comments to `//!` inner doc comments.

**tests/integration_round_trip.rs** — Change lines 1-12 from `///` to `//!`:
```rust
// BEFORE (lines 1-12):
/// Integration tests: encryption round-trip...
///
/// Tests cover:
///   1. Self-encrypt  — ...
// ... etc

// AFTER:
//! Integration tests: encryption round-trip...
//!
//! Tests cover:
//!   1. Self-encrypt  — ...
// ... etc
```

IMPORTANT: Only change the file-level header block (lines 1-12). Do NOT change any function-level `///` doc comments inside the file (e.g., `/// Fixed keypair with seed...` on functions). Those are valid outer doc comments.

**tests/plaintext_leak.rs** — Change lines 1-8 from `///` to `//!`:
```rust
// BEFORE (lines 1-8):
/// Plaintext leak detection tests.
///
/// Verify that encrypted blobs...
// ... etc

// AFTER:
//! Plaintext leak detection tests.
//!
//! Verify that encrypted blobs...
// ... etc
```

**Cargo.toml** — Add a comment above the `ed25519-dalek` dependency line explaining the exact pin:
```toml
# pkarr 5.0.3 requires ed25519-dalek 3.x pre-release; no stable 3.x exists yet.
# This exact pin must remain until pkarr publishes a release depending on a stable ed25519-dalek 3.x.
ed25519-dalek = "=3.0.0-pre.5"
```
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && cargo clippy --all-targets -- -D warnings 2>&1 | tail -5</automated>
    <manual>Confirm no clippy warnings or errors in output</manual>
  </verify>
  <done>
    - `///` converted to `//!` on lines 1-12 of integration_round_trip.rs and lines 1-8 of plaintext_leak.rs
    - Function-level `///` doc comments inside test files are unchanged
    - Cargo.toml has a 2-line comment above ed25519-dalek explaining the pkarr 5.0.3 constraint
    - `cargo clippy --all-targets -- -D warnings` exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Run cargo fmt on entire codebase</name>
  <files>
    src/cli.rs
    src/commands/init.rs
    src/commands/pickup.rs
    src/commands/publish.rs
    src/commands/revoke.rs
    src/crypto/mod.rs
    src/keys/store.rs
    src/record/mod.rs
    src/session/mod.rs
    src/transport/mod.rs
    tests/integration_round_trip.rs
    tests/plaintext_leak.rs
  </files>
  <action>
Run `cargo fmt` to reformat all Rust source files. This is a single command that handles all 12 files with formatting drift identified in the research.

```bash
cargo fmt
```

The changes are purely cosmetic (line-length reformatting, import ordering). No semantic changes. This MUST happen AFTER Task 1's clippy fixes, because both tools touch the test files and running fmt after the `///` → `//!` conversion ensures a single clean pass.

After running fmt, verify both gates pass:
```bash
cargo fmt --check     # Should exit 0
cargo clippy --all-targets -- -D warnings   # Should still exit 0
```
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && cargo fmt --check && cargo clippy --all-targets -- -D warnings 2>&1 | tail -3</automated>
  </verify>
  <done>
    - `cargo fmt --check` exits 0 on all source files
    - `cargo clippy --all-targets -- -D warnings` still exits 0 after formatting
    - All 12 files with formatting drift are now rustfmt-conformant
  </done>
</task>

</tasks>

<verification>
1. `cargo clippy --all-targets -- -D warnings` exits 0
2. `cargo fmt --check` exits 0
3. `grep -c '//!' tests/integration_round_trip.rs` returns at least 12 (inner doc comment lines)
4. `grep -c '//!' tests/plaintext_leak.rs` returns at least 8 (inner doc comment lines)
5. `grep 'pkarr 5.0.3' Cargo.toml` returns the constraint comment
</verification>

<success_criteria>
- clippy produces zero warnings on all targets including integration tests
- rustfmt reports no formatting drift across entire codebase
- ed25519-dalek pin is documented with pkarr constraint explanation
</success_criteria>

<output>
After completion, create `.planning/phases/11-prerequisites/11-01-SUMMARY.md`
</output>
