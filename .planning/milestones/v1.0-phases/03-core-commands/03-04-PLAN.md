---
phase: 03-core-commands
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli.rs
  - src/session/mod.rs
  - src/commands/publish.rs
autonomous: true
gap_closure: true
requirements: [SESS-01, UX-01]

must_haves:
  truths:
    - "Running `cclink --help` output contains the words 'Claude Code' in the about text"
    - "Running `cclink pickup --help` output contains the words 'Claude Code'"
    - "Running `cclink` from a directory with no matching Claude Code sessions prints a no-session error, even if sessions exist for other projects"
    - "Running `cclink` from a project directory with one active session auto-selects that session (does not show sessions from other projects)"
  artifacts:
    - path: "src/cli.rs"
      provides: "Claude Code-aware help strings"
      contains: "Claude Code"
    - path: "src/session/mod.rs"
      provides: "cwd-filtered session discovery"
      contains: "current_dir"
    - path: "src/commands/publish.rs"
      provides: "Passes cwd to discover_sessions"
      contains: "current_dir"
  key_links:
    - from: "src/commands/publish.rs"
      to: "src/session/mod.rs"
      via: "discover_sessions(Some(cwd))"
      pattern: "discover_sessions.*current_dir"
---

<objective>
Close two UAT gaps from Phase 3 user testing: (1) CLI help text omits any mention of "Claude Code", leaving users unaware what sessions are being handed off; (2) session discovery returns ALL sessions across all projects regardless of current working directory, breaking the expected behavior of filtering to the current project.

Purpose: These are the two blocking issues preventing real-world usability — users need to understand what the tool does (gap 1) and the auto-discovery must scope to the current project (gap 2).
Output: Updated src/cli.rs, src/session/mod.rs, src/commands/publish.rs with all 26+ tests passing.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-commands/03-UAT.md
@.planning/phases/03-core-commands/03-01-SUMMARY.md
@.planning/phases/03-core-commands/03-02-SUMMARY.md
@src/cli.rs
@src/session/mod.rs
@src/commands/publish.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Claude Code" references to all user-facing CLI help strings</name>
  <files>src/cli.rs</files>
  <action>
Update four help strings in src/cli.rs to mention "Claude Code" explicitly:

1. **Line 4 — top-level `about` on Cli struct:** Change from `"Secure session handoff via Pubky"` to `"Hand off a Claude Code session to another machine via Pubky"`.

2. **Line 6-7 — `session_id` field doc comment:** Change from `"Optional session ID to publish (auto-discovers most recent if omitted)"` to `"Claude Code session ID to publish (auto-discovers most recent if omitted)"`.

3. **Line 28-29 — `Pickup` variant doc comment:** Change from `"Pick up a session handoff from the homeserver"` to `"Pick up a Claude Code session handoff from the homeserver"`.

4. **Line 49 — `pubkey` field doc comment in PickupArgs:** Change from `"z32-encoded public key of the handoff publisher (defaults to own key)"` to `"z32-encoded public key of the Claude Code session publisher (defaults to own key)"`.

These are all clap doc comments that render directly in --help output. No logic changes, no struct changes — just string content.
  </action>
  <verify>
Run `cargo build` to confirm compilation. Then run:
- `cargo run -- --help` and verify the about line contains "Claude Code"
- `cargo run -- pickup --help` and verify both the subcommand description and PUBKEY help contain "Claude Code"
- `cargo test` to confirm no regressions (26 tests pass)
  </verify>
  <done>All four user-facing help strings in src/cli.rs contain "Claude Code". `cclink --help` and `cclink pickup --help` both clearly communicate this tool is for Claude Code sessions.</done>
</task>

<task type="auto">
  <name>Task 2: Filter session discovery by current working directory</name>
  <files>src/session/mod.rs, src/commands/publish.rs</files>
  <action>
**In src/session/mod.rs:**

1. Change the signature of `discover_sessions()` to accept an optional cwd filter:
   ```rust
   pub fn discover_sessions(cwd_filter: Option<&std::path::Path>) -> anyhow::Result<Vec<SessionInfo>>
   ```

2. After the existing mtime filter and `read_session_cwd()` call (around line 65-71), add a cwd filter step: if `cwd_filter` is `Some(cwd)`, only retain sessions whose `SessionInfo.project` starts with (or equals) the canonical cwd string. Use `std::fs::canonicalize` on both the filter path and the session project path for reliable prefix comparison. If canonicalize fails on the session project (stale path), skip that session.

   Specifically, after `read_session_cwd(&path)` succeeds and before pushing to `sessions`, add:
   ```rust
   // Filter by cwd if provided
   if let Some(filter_cwd) = cwd_filter {
       let canonical_filter = std::fs::canonicalize(filter_cwd)
           .unwrap_or_else(|_| filter_cwd.to_path_buf());
       let canonical_project = std::fs::canonicalize(&project)
           .unwrap_or_else(|_| std::path::PathBuf::from(&project));
       if !canonical_project.starts_with(&canonical_filter) {
           continue;
       }
   }
   ```

   Note: Move the `canonical_filter` computation outside the inner loop (compute once before the outer `for project_dir_entry` loop) to avoid redundant canonicalize calls.

3. Update the existing unit test `discover_sessions_returns_vec_when_no_projects_dir` to pass `None` as the cwd_filter argument.

4. Add a new unit test `discover_sessions_filters_by_cwd` that verifies the filtering behavior. Since we can't easily create real session files in tests, this test should call `discover_sessions(Some(Path::new("/nonexistent/path/that/matches/nothing")))` and assert it returns `Ok` with an empty Vec (any real sessions won't match this path). This is a smoke test for the parameter plumbing.

**In src/commands/publish.rs:**

5. Update the `discover_sessions()` call at line 33 to pass the current working directory:
   ```rust
   let cwd = std::env::current_dir().ok();
   let mut sessions = crate::session::discover_sessions(cwd.as_deref())?;
   ```

   This ensures that when a user runs `cclink` from `~/vault/projects/foo`, only sessions whose project cwd starts with that path are returned. If no sessions match, the existing `0 =>` branch prints the red "No Claude Code session found" error — which is exactly the correct behavior the UAT expects.
  </action>
  <verify>
Run `cargo build` to confirm compilation. Run `cargo test` to confirm all tests pass (should be 27+ now with the new test). Run `cargo clippy` to check for any new warnings. Verify the function signature change compiles cleanly with no callers missed by grepping for `discover_sessions` across the codebase.
  </verify>
  <done>discover_sessions() accepts an optional cwd filter parameter. run_publish() passes std::env::current_dir() to scope discovery to the current project. Sessions from unrelated projects are excluded. Running cclink from a directory with no matching sessions shows the "No Claude Code session found" error even if other projects have active sessions.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cargo build` succeeds (warnings OK)
2. `cargo test` passes all tests (27+, 0 failed)
3. `cargo run -- --help` output contains "Claude Code" in the about line
4. `cargo run -- pickup --help` output contains "Claude Code" in subcommand and PUBKEY descriptions
5. `grep -n "Claude Code" src/cli.rs` returns 4 matches
6. `grep -n "cwd_filter\|current_dir" src/session/mod.rs src/commands/publish.rs` confirms the filter plumbing
</verification>

<success_criteria>
Both UAT gaps are closed:
- Gap 1 (minor): All user-facing help strings mention "Claude Code" — users understand what sessions are being handed off
- Gap 2 (major): Session discovery scopes to current working directory — running cclink from a project without matching sessions shows the no-session error instead of listing unrelated sessions
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-commands/03-04-SUMMARY.md`
</output>
