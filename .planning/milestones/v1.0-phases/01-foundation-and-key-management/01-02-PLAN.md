---
phase: 01-foundation-and-key-management
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/commands/whoami.rs
  - src/cli.rs
  - src/commands/mod.rs
  - src/main.rs
  - Cargo.toml
autonomous: true
requirements:
  - KEY-02

must_haves:
  truths:
    - "User runs `cclink whoami` and sees their PKARR public key in pk: URI format"
    - "User runs `cclink whoami` and sees their homeserver URL, key file path, and short fingerprint"
    - "User runs `cclink whoami` and the public key is auto-copied to clipboard with confirmation message"
    - "If clipboard is unavailable (SSH/headless), whoami still works and prints a manual-copy message instead"
    - "User runs `cclink whoami` without having run init and sees 'No keypair found. Run `cclink init` first.'"
  artifacts:
    - path: "src/commands/whoami.rs"
      provides: "cclink whoami command: load keypair, display identity, clipboard copy"
      contains: "run_whoami"
    - path: "Cargo.toml"
      provides: "arboard dependency added for clipboard access"
      contains: "arboard"
  key_links:
    - from: "src/commands/whoami.rs"
      to: "src/keys/store.rs"
      via: "load_keypair() to get existing keypair, read_homeserver() for homeserver URL"
      pattern: "load_keypair|read_homeserver"
    - from: "src/commands/whoami.rs"
      to: "src/keys/fingerprint.rs"
      via: "short_fingerprint() for display"
      pattern: "short_fingerprint"
    - from: "src/commands/whoami.rs"
      to: "arboard::Clipboard"
      via: "Graceful clipboard copy with fallback message"
      pattern: "Clipboard::new"
    - from: "src/main.rs"
      to: "src/commands/whoami.rs"
      via: "Commands::Whoami match arm calls run_whoami()"
      pattern: "run_whoami"
---

<objective>
Implement the `cclink whoami` command that loads the stored keypair and displays the user's PKARR identity with clipboard support.

Purpose: Completes the identity workflow — after `cclink init` creates the keypair, `cclink whoami` lets the user inspect and share their public key. This is the user's primary way to verify their identity before publishing handoffs.
Output: A working `cclink whoami` that shows public key, fingerprint, homeserver, key file path, and copies the public key to clipboard.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-key-management/01-RESEARCH.md
@.planning/phases/01-foundation-and-key-management/01-CONTEXT.md
@.planning/phases/01-foundation-and-key-management/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add arboard dependency and implement cclink whoami command</name>
  <files>
    Cargo.toml
    src/commands/whoami.rs
    src/commands/mod.rs
    src/main.rs
  </files>
  <action>
Add clipboard dependency and implement the whoami command.

**Cargo.toml:**
- Add dependency: `arboard = "3.6"` (for clipboard access)

**src/commands/whoami.rs** — `run_whoami() -> anyhow::Result<()>`:

1. Load keypair: `let keypair = keys::store::load_keypair()?` — if no keypair exists, this returns the `NoKeypairFound` error with message "No keypair found. Run `cclink init` first."
2. Get public key: `let public_key = keypair.public_key()`
3. Get public key URI: `let pubkey_uri = public_key.to_uri_string()` — format is `pk:<z32>`
4. Get fingerprint: `let fingerprint = keys::fingerprint::short_fingerprint(&public_key)` — first 8 chars of z32
5. Get homeserver: `let homeserver = keys::store::read_homeserver()?` — reads from `~/.pubky/cclink_homeserver` or defaults to "https://pubky.app"
6. Get key file path: `let key_path = keys::store::secret_key_path()?`

**Display output** (per locked decisions):
```
Public Key:  pk:o4dksfbqk85ogzdb5osziw6befigbuxmuxkuxq8434q89uj56uyy
Fingerprint: o4dksfbq
Homeserver:  https://pubky.app
Key file:    /home/user/.pubky/secret_key
```

**Clipboard** (per locked decisions — auto-copy with graceful degradation):
```rust
fn try_copy_to_clipboard(text: &str) -> bool {
    match arboard::Clipboard::new() {
        Ok(mut clipboard) => clipboard.set_text(text).is_ok(),
        Err(_) => false,
    }
}
```

After the display output, add a blank line then:
- If clipboard succeeds: `"Public key copied to clipboard."`
- If clipboard fails: `"(Clipboard unavailable — copy public key manually)"`

**IMPORTANT:** Never `unwrap()` or `expect()` on clipboard operations. arboard returns `Err` in SSH sessions, headless environments, and when no display server (X11/Wayland) is available. Always handle the error gracefully.

**src/commands/mod.rs:**
- Ensure `pub mod whoami;` is declared (may already be a placeholder from Plan 01)

**src/main.rs:**
- Update the `Commands::Whoami` match arm to call `commands::whoami::run_whoami()?` (replacing the "Not yet implemented" placeholder from Plan 01)

**src/cli.rs:**
- No changes needed — `Whoami` variant already exists from Plan 01
  </action>
  <verify>
    Build with `cargo build`. Then test:
    1. First, ensure a keypair exists: `./target/debug/cclink init --yes`
    2. `./target/debug/cclink whoami` — should show public key in `pk:` format, fingerprint (8 chars), homeserver URL, key file path
    3. Verify the public key starts with `pk:` and is followed by z-base32 characters
    4. Verify the fingerprint matches the first 8 characters after `pk:` in the public key
    5. Check clipboard: paste in terminal — should match the public key URI (or see "clipboard unavailable" message in SSH)
    6. Delete the key file: `rm ~/.pubky/secret_key`, then run `./target/debug/cclink whoami` — should show "No keypair found. Run `cclink init` first."
    7. Restore key: `./target/debug/cclink init --yes`
    8. Test with custom homeserver: `./target/debug/cclink init --homeserver https://custom.test --yes`, then `./target/debug/cclink whoami` — should show "https://custom.test" as homeserver
  </verify>
  <done>
    `cclink whoami` loads the stored keypair and displays the PKARR public key (pk: URI), fingerprint, homeserver, and key file path. The public key is auto-copied to clipboard with a confirmation message, or a fallback message is shown when clipboard is unavailable. Missing keypair produces the correct "No keypair found" error.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end integration verification of init + whoami workflow</name>
  <files>
    src/commands/init.rs
    src/commands/whoami.rs
  </files>
  <action>
Run the complete identity workflow end-to-end and fix any issues discovered. This is NOT a code-writing task — it is a verification and fix-up task.

**Test sequence:**

1. **Clean state:** Remove `~/.pubky/` directory entirely: `rm -rf ~/.pubky/`
2. **First init:** `./target/debug/cclink init` — expect success, key created, output shows public key
3. **Whoami after init:** `./target/debug/cclink whoami` — expect matching public key from init output
4. **Identity round-trip:** The public key shown by `init` MUST match the public key shown by `whoami` — verify they are identical
5. **Import round-trip:** Copy the secret key hex, delete ~/.pubky/, import via `cclink init --import - --yes`, then `cclink whoami` — public key MUST be the same as the original
6. **File import:** `cp ~/.pubky/secret_key /tmp/test_key && rm -rf ~/.pubky/ && ./target/debug/cclink init --import /tmp/test_key --yes && ./target/debug/cclink whoami` — public key MUST match
7. **Overwrite flow:** Run `cclink init` again without `--yes` — verify prompt shows fingerprint, answering "n" aborts, answering "y" generates new key (different public key)
8. **Custom homeserver persistence:** `cclink init --homeserver https://test.server --yes`, then `cclink whoami` — homeserver must show "https://test.server"
9. **Error paths:**
   - `rm ~/.pubky/secret_key && ./target/debug/cclink whoami` — must show "No keypair found"
   - `echo "baddata" | ./target/debug/cclink init --import - --yes` — must fail with clear error
   - `./target/debug/cclink init --import /nonexistent --yes` — must fail with clear error
10. **Permissions check:** `stat -c '%a' ~/.pubky/secret_key` — must be `600`

**If any test fails:** Fix the issue in the relevant source file. Common fixes:
- Public key mismatch between init and whoami → check if both derive from same keypair loading path
- Homeserver not persisting → verify `write_homeserver` is called in init and `read_homeserver` is called in whoami
- Permissions wrong → check pkarr's `write_secret_key_file` behavior, may need manual `set_permissions` call after atomic rename
- Import from stdin failing → check hex parsing, temp file approach, newline trimming

**Permissions edge case:** After the atomic rename (`std::fs::rename`), verify that the 0600 permissions set by `write_secret_key_file` on the temp file are preserved through the rename. On POSIX, rename preserves permissions, but verify explicitly. If permissions are lost, add an explicit `std::fs::set_permissions` call after rename in `write_keypair_atomic`.

After all tests pass, clean up any temp files created during testing.
  </action>
  <verify>
    All 10 test scenarios pass. `cargo build` still compiles cleanly. The key file has 0600 permissions after both generate and import paths.
  </verify>
  <done>
    The full init-to-whoami workflow works end-to-end: generate, import (file + stdin), overwrite protection, identity display, clipboard copy, homeserver persistence, and all error paths produce correct messages. KEY-01, KEY-02, KEY-03, and KEY-04 are all satisfied.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `cclink whoami` displays public key (pk: URI), fingerprint, homeserver, key file path
3. Clipboard copy works or degrades gracefully
4. `cclink whoami` without init shows "No keypair found. Run `cclink init` first."
5. Full round-trip: init → whoami → import → whoami all show consistent public key
6. Custom homeserver persists across init and whoami
</verification>

<success_criteria>
- `cclink whoami` displays all four fields: public key, fingerprint, homeserver, key file path
- Public key is auto-copied to clipboard (with graceful fallback)
- Missing keypair error is clear and actionable
- End-to-end workflow (init + whoami) is verified and consistent
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-key-management/01-02-SUMMARY.md`
</output>
