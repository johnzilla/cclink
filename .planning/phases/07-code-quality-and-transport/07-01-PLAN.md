---
phase: 07-code-quality-and-transport
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/util.rs
  - src/error.rs
  - src/transport/mod.rs
  - src/commands/pickup.rs
  - src/commands/list.rs
  - src/main.rs
  - src/lib.rs
autonomous: true
requirements:
  - QUAL-01
  - QUAL-02
  - QUAL-03

must_haves:
  truths:
    - "`human_duration` exists in exactly one place — `src/util.rs` — and both pickup.rs and list.rs import it from there"
    - "Pickup retry loop never matches on the string '404' or 'not found' — uses typed CclinkError::RecordNotFound"
    - "List command never matches on the string '404' or 'not found' — the transport layer returns typed errors"
    - "`cargo build` produces zero compiler warnings (no unused variant warnings)"
    - "Dead CclinkError variants (InvalidKeyFormat, KeyCorrupted, RecordDeserializationFailed) are removed"
  artifacts:
    - path: "src/util.rs"
      provides: "Shared human_duration function"
      exports: ["human_duration"]
    - path: "src/error.rs"
      provides: "CclinkError with RecordNotFound variant, dead variants removed"
      contains: "RecordNotFound"
    - path: "src/transport/mod.rs"
      provides: "get_bytes returns CclinkError::RecordNotFound on 404 instead of string-based anyhow error"
  key_links:
    - from: "src/commands/pickup.rs"
      to: "src/util.rs"
      via: "use crate::util::human_duration"
      pattern: "crate::util::human_duration"
    - from: "src/commands/list.rs"
      to: "src/util.rs"
      via: "use crate::util::human_duration"
      pattern: "crate::util::human_duration"
    - from: "src/transport/mod.rs"
      to: "src/error.rs"
      via: "CclinkError::RecordNotFound"
      pattern: "CclinkError::RecordNotFound"
    - from: "src/commands/pickup.rs"
      to: "src/error.rs"
      via: "downcast_ref::<CclinkError> for typed 404 detection"
      pattern: "RecordNotFound"
---

<objective>
Clean up error handling, extract shared utilities, and replace stringly-typed 404 detection with structured error variants.

Purpose: Eliminate code duplication (`human_duration` in two files), remove dead `CclinkError` variants that produce compiler warnings, and replace fragile string matching on "404"/"not found" in the retry loop with typed `CclinkError::RecordNotFound` so error handling is correct by construction.

Output: Zero compiler warnings, one canonical `human_duration`, typed 404 errors throughout.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/error.rs
@src/transport/mod.rs
@src/commands/pickup.rs
@src/commands/list.rs
@src/main.rs
@src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract human_duration to shared util module and restructure CclinkError</name>
  <files>src/util.rs, src/error.rs, src/commands/pickup.rs, src/commands/list.rs, src/main.rs, src/lib.rs</files>
  <action>
1. Create `src/util.rs` with a single `pub fn human_duration(secs: u64) -> String` — same logic as the existing implementations (>= 3600 -> Xh, >= 60 -> Xm, else Xs). Move the tests from `pickup.rs::tests` into `util.rs::tests` (keep boundary + edge cases).

2. In `src/main.rs`, add `mod util;` alongside the other module declarations.

3. In `src/lib.rs`, add `pub mod util;` so integration tests can access it if needed.

4. In `src/commands/pickup.rs`:
   - Remove the `fn human_duration(...)` definition entirely.
   - Remove the `mod tests` block for `human_duration` tests (they live in util.rs now).
   - Add `use crate::util::human_duration;` at the top (after existing imports).
   - All call sites (`human_duration(...)`) continue to work unchanged.

5. In `src/commands/list.rs`:
   - Remove the `fn human_duration(...)` definition entirely.
   - Remove the `mod tests` block for `human_duration` tests (they live in util.rs now).
   - Add `use crate::util::human_duration;` at the top (after existing imports).

6. **Pre-check:** Before removing any variants, run `grep -rn 'HandoffExpired\|NetworkRetryExhausted' src/` and confirm zero matches outside `src/error.rs`. This proves they are dead code and safe to remove.

7. In `src/error.rs`, restructure `CclinkError`:
   - **Remove** dead variants: `InvalidKeyFormat(String)`, `KeyCorrupted(String)`, `RecordDeserializationFailed(String)`, `HandoffExpired(String)`, `NetworkRetryExhausted(String)`.
   - **Add** `RecordNotFound` variant: `#[error("Record not found")] RecordNotFound` (no payload needed — the URL context is added by the caller via anyhow context).
   - Keep existing used variants: `NoKeypairFound`, `AtomicWriteFailed`, `HomeDirNotFound`, `SignatureVerificationFailed`, `SessionNotFound`.
   - Result: CclinkError has exactly 6 variants (5 existing used + 1 new RecordNotFound).
  </action>
  <verify>
`grep -rn 'HandoffExpired\|NetworkRetryExhausted' src/` shows matches only in `src/error.rs` (confirming safe removal). `cargo build 2>&1 | grep -c warning` outputs 0 (zero warnings). `cargo test -- util::tests` passes all human_duration tests.
  </verify>
  <done>
`human_duration` exists in exactly one file (`src/util.rs`). No dead CclinkError variants remain. CclinkError has a new `RecordNotFound` variant. The binary compiles with zero warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace stringly-typed 404 detection with typed CclinkError::RecordNotFound</name>
  <files>src/transport/mod.rs, src/commands/pickup.rs</files>
  <action>
1. In `src/transport/mod.rs`, modify the private `get_bytes()` method:
   - Instead of `anyhow::bail!("Record not found at {}", url)` on 404, return: `Err(crate::error::CclinkError::RecordNotFound.into())` — this produces an `anyhow::Error` that can be downcast to `CclinkError`.
   - The non-404 error path (`GET failed (status {})`) stays as-is with `anyhow::bail!`.

2. In `src/transport/mod.rs`, verify that `list_record_tokens()` already handles 404 correctly (returns `Ok(vec![])` on 404) — no string matching there, so no change needed.

3. In `src/commands/pickup.rs`, replace all `msg.contains("not found") || msg.contains("404")` checks in the retry loop with typed error detection using `downcast_ref`:

   Replace the pattern:
   ```rust
   Err(e) => {
       let msg = e.to_string();
       if msg.contains("not found") || msg.contains("404") {
           return Err(BackoffError::permanent(e));
       }
       return Err(BackoffError::transient(e));
   }
   ```

   With:
   ```rust
   Err(e) => {
       if e.downcast_ref::<crate::error::CclinkError>()
           .map_or(false, |ce| matches!(ce, crate::error::CclinkError::RecordNotFound))
       {
           return Err(BackoffError::permanent(e));
       }
       return Err(BackoffError::transient(e));
   }
   ```

   Apply this to ALL THREE error-handling sites in the retry closure:
   a. After `client.get_latest(...)` failure
   b. After `client.get_record_by_pubkey(...)` failure (cross-user path)
   c. After `client.get_record(...)` failure (self-pickup path)

   Note: `get_latest()` calls `get_bytes()` internally, so it will also produce `CclinkError::RecordNotFound` on 404 — no string matching needed.

4. Ensure no string "404" or "not found" appears in any error-matching code path in pickup.rs. The only remaining string references to "not found" should be in user-facing error messages or doc comments, not in error-detection logic.
  </action>
  <verify>
`cargo build 2>&1 | grep -c warning` outputs 0. `cargo test` passes. `grep -n 'contains.*"not found"\|contains.*"404"' src/commands/pickup.rs` returns no matches. `grep -n 'contains.*"not found"\|contains.*"404"' src/commands/list.rs` returns no matches.
  </verify>
  <done>
Error handling in pickup never matches on the string "404" or "not found". The transport layer returns `CclinkError::RecordNotFound` on HTTP 404. Pickup uses `downcast_ref` for typed error detection. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cargo build 2>&1 | grep warning` — must produce no output (zero warnings)
2. `cargo test` — all tests pass
3. `grep -rn 'human_duration' src/` — appears in `src/util.rs` definition, plus `use crate::util::human_duration` in pickup.rs and list.rs (no standalone definitions elsewhere)
4. `grep -rn 'contains.*"not found"\|contains.*"404"' src/commands/pickup.rs src/commands/list.rs` — no matches
5. `grep -rn 'RecordNotFound' src/` — appears in error.rs (definition) and transport/mod.rs (usage) and pickup.rs (downcast check)
</verification>

<success_criteria>
- Zero compiler warnings from `cargo build`
- `human_duration` defined in exactly one file (`src/util.rs`)
- No string matching on "404"/"not found" in pickup.rs or list.rs error handling
- Dead CclinkError variants removed (InvalidKeyFormat, KeyCorrupted, RecordDeserializationFailed, HandoffExpired, NetworkRetryExhausted)
- New CclinkError::RecordNotFound variant used by transport layer
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-quality-and-transport/07-01-SUMMARY.md`
</output>
