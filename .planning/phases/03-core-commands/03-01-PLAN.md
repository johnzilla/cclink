---
phase: 03-core-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/session/mod.rs
  - src/error.rs
autonomous: true
requirements:
  - SESS-01
  - UX-01

must_haves:
  truths:
    - "Session discovery finds the most recent Claude Code session by mtime"
    - "Sessions older than 24 hours are excluded from discovery"
    - "Session ID and project path are extracted from JSONL progress records"
    - "Multiple active sessions are returned sorted by recency"
    - "New error variants exist for session-not-found and TTL-expired cases"
    - "owo-colors, dialoguer, qr2term, and backoff crates compile successfully"
  artifacts:
    - path: "src/session/mod.rs"
      provides: "Session discovery module with SessionInfo struct and discover_sessions()"
      exports: ["SessionInfo", "discover_sessions"]
      min_lines: 60
    - path: "src/error.rs"
      provides: "Error enum with SessionNotFound and TTL expired variants"
      contains: "SessionNotFound"
    - path: "Cargo.toml"
      provides: "All Phase 3 dependencies"
      contains: "owo-colors"
  key_links:
    - from: "src/session/mod.rs"
      to: "~/.claude/projects/"
      via: "dirs::home_dir() + fs::read_dir"
      pattern: "home_dir.*\\.claude/projects"
---

<objective>
Add Phase 3 dependencies to Cargo.toml and implement the session discovery module that scans `~/.claude/projects/` for active Claude Code sessions.

Purpose: Session discovery is the foundation for the publish command. All new crate dependencies (owo-colors, dialoguer, qr2term, backoff) must compile before the command implementations can begin.

Output: `src/session/mod.rs` with `SessionInfo` struct and `discover_sessions()` function; updated `Cargo.toml` with all Phase 3 deps; updated `src/error.rs` with new error variants.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-commands/03-RESEARCH.md
@src/error.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 3 dependencies and new error variants</name>
  <files>Cargo.toml, src/error.rs</files>
  <action>
Add the following dependencies to Cargo.toml under [dependencies]:

```toml
owo-colors = { version = "4", features = ["supports-colors"] }
dialoguer = "0.12"
qr2term = "0.3"
backoff = "0.4"
```

Update `src/error.rs` to add three new error variants to `CclinkError`:

```rust
#[error("No Claude Code session found. Start a session with 'claude' first.")]
SessionNotFound,

#[error("This handoff expired {0} ago. Publish a new one with cclink.")]
HandoffExpired(String),

#[error("Network request failed after retries: {0}")]
NetworkRetryExhausted(String),
```

Run `cargo check` to verify all new dependencies resolve and compile.
  </action>
  <verify>`cargo check` succeeds with no errors</verify>
  <done>Cargo.toml has owo-colors (with supports-colors feature), dialoguer, qr2term, backoff. CclinkError has SessionNotFound, HandoffExpired, and NetworkRetryExhausted variants.</done>
</task>

<task type="auto">
  <name>Task 2: Implement session discovery module</name>
  <files>src/session/mod.rs</files>
  <action>
Create `src/session/mod.rs` implementing session discovery per the research findings.

**SessionInfo struct:**
```rust
pub struct SessionInfo {
    pub session_id: String,
    pub project: String,  // cwd from JSONL progress record
    pub mtime: SystemTime,
}
```

**discover_sessions() function:**
1. Resolve `~/.claude/projects/` via `dirs::home_dir()`
2. If directory does not exist, return empty Vec (not an error)
3. Apply 24-hour mtime cutoff to filter active sessions
4. For each subdirectory in projects/:
   - Iterate `*.jsonl` files
   - Skip files with mtime older than 24h cutoff
   - Extract `session_id` from filename stem (the UUID)
   - Call `read_session_cwd()` to get the project path from JSONL
5. Sort results by mtime descending (most recent first)
6. Return `Vec<SessionInfo>`

**read_session_cwd() helper:**
- Open the JSONL file with BufReader
- Read up to 20 lines (cap to avoid reading large files)
- For each line, parse as `serde_json::Value`
- Look for a line where `obj["cwd"]` is a non-empty string
- Return the `cwd` string, or bail if not found within 20 lines

IMPORTANT: Do NOT attempt to decode the directory name — it uses a lossy formula. Always read `cwd` from the JSONL file directly.

Add `mod session;` to `src/main.rs` (after `mod record;`).

Run `cargo check` to verify the module compiles and integrates.
  </action>
  <verify>`cargo check` succeeds; `cargo test` passes all existing tests (no regressions)</verify>
  <done>`src/session/mod.rs` exists with `SessionInfo` and `discover_sessions()`. The function scans `~/.claude/projects/`, filters by 24h mtime, reads cwd from JSONL progress records, and returns sessions sorted by recency. Module is registered in main.rs.</done>
</task>

</tasks>

<verification>
1. `cargo check` passes — all dependencies resolve, session module compiles
2. `cargo test` passes — no regressions in existing Phase 1/2 tests
3. `src/session/mod.rs` contains `SessionInfo` struct with session_id, project, mtime fields
4. `src/session/mod.rs` contains `discover_sessions()` returning `Vec<SessionInfo>`
5. `src/error.rs` contains `SessionNotFound`, `HandoffExpired`, `NetworkRetryExhausted` variants
6. `Cargo.toml` contains owo-colors, dialoguer, qr2term, backoff
</verification>

<success_criteria>
All Phase 3 dependencies compile. Session discovery module is ready to be consumed by the publish command. Error variants are available for all Phase 3 error conditions.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-commands/03-01-SUMMARY.md`
</output>
