---
phase: 11-prerequisites
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - Cargo.toml
  - Cargo.lock
  - src/commands/pickup.rs
autonomous: true
requirements:
  - DEP-02

must_haves:
  truths:
    - "cargo audit produces no unresolved vulnerability or unmaintained advisories"
    - "Retry behavior in pickup.rs is functionally equivalent to the old backoff implementation"
    - "RecordNotFound errors stop retrying immediately (not retried)"
    - "Transient network errors are retried with exponential backoff"
  artifacts:
    - path: "Cargo.toml"
      provides: "backon dependency replacing backoff"
      contains: "backon"
    - path: "src/commands/pickup.rs"
      provides: "Retry logic using backon BlockingRetryable"
      contains: "BlockingRetryable"
  key_links:
    - from: "src/commands/pickup.rs"
      to: "backon crate"
      via: "use backon::{BlockingRetryable, ExponentialBuilder}"
      pattern: "use backon::"
    - from: "src/commands/pickup.rs"
      to: "crate::error::CclinkError::RecordNotFound"
      via: ".when() predicate stops retrying on permanent errors"
      pattern: "\\.when\\(|RecordNotFound"
---

<objective>
Replace the unmaintained `backoff` crate with `backon 1.6` to resolve RUSTSEC-2025-0012 (backoff unmaintained) and its transitive RUSTSEC-2024-0384 (instant unmaintained).

Purpose: Eliminate both RUSTSEC advisories so `cargo audit` passes cleanly. The `backoff` crate is unmaintained and its advisory explicitly recommends `backon` as a replacement.

Output: pickup.rs uses backon for retry logic, Cargo.toml depends on backon instead of backoff, cargo audit exits 0.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-prerequisites/11-RESEARCH.md
@.planning/phases/11-prerequisites/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace backoff with backon in Cargo.toml and rewrite retry logic in pickup.rs</name>
  <files>
    Cargo.toml
    src/commands/pickup.rs
  </files>
  <action>
**Cargo.toml** — Replace the backoff dependency with backon:
```toml
# Remove this line:
backoff = "0.4"

# Add this line (in alphabetical position among dependencies):
backon = "1.6"
```

**src/commands/pickup.rs** — Rewrite the retry block in `run_pickup()`.

Remove old imports (line 59 inside the function):
```rust
use backoff::{retry, ExponentialBackoff, Error as BackoffError};
```

Add new import at the top of the file (with other use statements):
```rust
use backon::{BlockingRetryable, ExponentialBuilder};
```

Replace the backoff config and retry block (approximately lines 71-93) with:
```rust
let target_z32_owned = target_z32.to_string();
let record = (|| client.resolve_record(&target_z32_owned))
    .retry(
        ExponentialBuilder::default()
            .with_min_delay(std::time::Duration::from_secs(2))
            .with_max_delay(std::time::Duration::from_secs(8))
            .with_max_times(6),
    )
    .sleep(std::thread::sleep)
    .when(|e| {
        // Retry on transient errors; stop immediately on RecordNotFound (permanent)
        !e.downcast_ref::<crate::error::CclinkError>()
            .is_some_and(|ce| matches!(ce, crate::error::CclinkError::RecordNotFound))
    })
    .call()
    .map_err(|e| anyhow::anyhow!("Failed to retrieve handoff after retries: {}", e))?;
```

Key semantic differences to get right:
- `.sleep(std::thread::sleep)` is REQUIRED for blocking code — without it backon does not actually delay between retries
- `.when()` predicate returns `true` to CONTINUE retrying and `false` to STOP — this is the INVERSE of backoff's `BackoffError::permanent` semantics
- `with_max_times(6)` approximates the old `max_elapsed_time: 30s` with delays of 2s-8s (worst case ~38s)
- The `use backoff::...` was inside the function body; move `use backon::...` to file-level imports for idiomatic Rust

After making changes, run `cargo fmt` to ensure the new code is formatted consistently.

Verify backon docs if needed: check whether `ExponentialBuilder` has a `with_total_delay` method by running `cargo doc -p backon --no-deps` and inspecting the output. If `with_total_delay` exists, prefer it over `with_max_times(6)` with value `Duration::from_secs(30)` for closer parity with the original behavior. If it does not exist, `with_max_times(6)` is the correct fallback.
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && cargo build 2>&1 | tail -5 && cargo clippy --all-targets -- -D warnings 2>&1 | tail -5 && cargo fmt --check</automated>
    <manual>Verify the code compiles and the retry logic is functionally equivalent</manual>
  </verify>
  <done>
    - `backoff` removed from Cargo.toml, `backon = "1.6"` added
    - pickup.rs uses `backon::{BlockingRetryable, ExponentialBuilder}` for retry
    - `.sleep(std::thread::sleep)` is present (blocking retries actually sleep)
    - `.when()` predicate returns false for RecordNotFound (stops retrying)
    - `cargo build` succeeds with no errors
    - `cargo clippy --all-targets -- -D warnings` still exits 0
    - `cargo fmt --check` still exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify all three Phase 11 gates pass</name>
  <files>
    Cargo.lock
  </files>
  <action>
Run all three verification gates in sequence to confirm the entire phase is complete:

```bash
# Gate 1: Clippy (clean lint)
cargo clippy --all-targets -- -D warnings

# Gate 2: Format (clean formatting)
cargo fmt --check

# Gate 3: Audit (no advisories)
cargo audit
```

All three must exit 0 with no errors, warnings, or unresolved advisories.

If `cargo audit` is not installed, install it first:
```bash
cargo install cargo-audit
```

Additionally verify:
- `cargo test` still passes (the retry refactor must not break any existing tests)
- `grep -c 'backoff' Cargo.toml` returns 0 (old dependency fully removed)
- `grep -c 'backon' Cargo.toml` returns 1 (new dependency present)

Note: Cargo.lock will be updated automatically when backoff is removed and backon is added. This is expected. The lock file change is a side effect of the dependency swap and does not need manual editing.
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && cargo clippy --all-targets -- -D warnings 2>&1 | tail -3 && cargo fmt --check && cargo audit 2>&1 | tail -10 && cargo test 2>&1 | tail -5</automated>
  </verify>
  <done>
    - `cargo clippy --all-targets -- -D warnings` exits 0
    - `cargo fmt --check` exits 0
    - `cargo audit` exits 0 with no unresolved advisories (RUSTSEC-2025-0012 and RUSTSEC-2024-0384 both gone)
    - `cargo test` passes (no regressions from backoff → backon migration)
    - Cargo.lock no longer contains backoff or instant entries
  </done>
</task>

</tasks>

<verification>
1. `cargo clippy --all-targets -- -D warnings` exits 0
2. `cargo fmt --check` exits 0
3. `cargo audit` exits 0 — no RUSTSEC-2025-0012 (backoff) or RUSTSEC-2024-0384 (instant)
4. `cargo test` passes with no failures
5. `grep 'backoff' Cargo.toml` returns nothing (old dependency removed)
6. `grep 'backon' Cargo.toml` returns the new dependency line
7. `grep 'BlockingRetryable' src/commands/pickup.rs` confirms new retry pattern
</verification>

<success_criteria>
- Both RUSTSEC advisories eliminated by replacing backoff with backon
- Retry behavior in pickup.rs is functionally equivalent (RecordNotFound stops immediately, transient errors retry with exponential backoff)
- All three Phase 11 gates pass: clippy, fmt, audit
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-prerequisites/11-02-SUMMARY.md`
</output>
