---
phase: 10-pubky-homeserver-transport-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/transport/mod.rs
autonomous: true
requirements:
  - FUNC-04

must_haves:
  truths:
    - "Every HTTP request to the homeserver includes a Host header with a z32-encoded pubkey"
    - "First-time users are automatically signed up when POST /session returns 404"
    - "Cross-user GET uses Host header for tenant identification instead of embedding pubkey in URL path"
    - "Self-operations (publish, list, revoke, self-pickup) use the client's own pubkey in the Host header"
    - "Cross-user operations (shared pickup) use the target user's pubkey in the Host header"
  artifacts:
    - path: "src/transport/mod.rs"
      provides: "HomeserverClient with pubkey_z32 field and Host header on all requests"
      contains: "pubkey_z32"
  key_links:
    - from: "HomeserverClient::new"
      to: "pubkey_z32 field"
      via: "constructor parameter or setter"
      pattern: "pubkey_z32"
    - from: "all HTTP request methods"
      to: "Host header"
      via: ".header(\"Host\", ...)"
      pattern: "\\.header\\(\"Host\""
    - from: "signin"
      to: "signup fallback"
      via: "404 status check then POST /signup"
      pattern: "/signup"
---

<objective>
Fix the HomeserverClient transport layer to correctly interact with the Pubky homeserver's virtual hosting API.

Purpose: The Pubky homeserver uses the Host header to identify tenants. Without it, every request returns 404. Additionally, first-time users need POST /signup (not just /session), and cross-user reads must use Host header routing instead of path-based pubkey embedding.

Output: A working HomeserverClient that includes the Host header on all requests, handles signup/session flow for first-time users, and correctly routes cross-user operations via Host header.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/transport/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pubkey_z32 field and Host header to HomeserverClient</name>
  <files>src/transport/mod.rs</files>
  <action>
  Modify `HomeserverClient` to carry the owner's z32-encoded pubkey and include it as a Host header on every request:

  1. **Add `pubkey_z32: String` field** to the `HomeserverClient` struct. This is the z32-encoded public key of the keypair that owns this client instance.

  2. **Update `HomeserverClient::new()`** to accept a second parameter `pubkey_z32: &str`:
     ```rust
     pub fn new(homeserver: &str, pubkey_z32: &str) -> anyhow::Result<Self>
     ```
     Store `pubkey_z32.to_string()` in the struct.

  3. **Add a private helper method** `host_header(&self, pubkey_z32: Option<&str>) -> String` that returns the pubkey to use as the Host header value. If `pubkey_z32` is `Some(pk)`, use that (cross-user operation). Otherwise, use `self.pubkey_z32` (self operation).

  4. **Add Host header to `signin()`**: The POST `/session` request must include `.header("Host", &self.pubkey_z32)`. This is always a self-operation.

  5. **Add Host header to `put_record()`**: Include `.header("Host", &self.pubkey_z32)`. Always a self-operation (only the owner publishes their own records).

  6. **Add Host header to `put_latest()`**: Include `.header("Host", &self.pubkey_z32)`. Always a self-operation.

  7. **Add Host header to `delete_record()`**: Include `.header("Host", &self.pubkey_z32)`. Always a self-operation (only the owner deletes their own records).

  8. **Add Host header to `list_record_tokens()`**: Include `.header("Host", &self.pubkey_z32)`. Always a self-operation.

  9. **Update `get_bytes()` to accept an optional target pubkey** for the Host header. Change the signature to:
     ```rust
     fn get_bytes(&self, url: &str, host_pubkey: Option<&str>) -> anyhow::Result<Vec<u8>>
     ```
     Include `.header("Host", self.host_header(host_pubkey))` on the GET request.

  10. **Update `get_record()`** to pass `None` (self-operation) to `get_bytes`.

  11. **Fix `get_record_by_pubkey()`**: This is the critical cross-user fix. Change the URL from `/{pubkey_z32}/pub/cclink/{token}` to `/pub/cclink/{token}` (same path as self-operation). The tenant differentiation happens via the Host header, not the URL path. Pass `Some(pubkey_z32)` to `get_bytes` so the Host header is the TARGET user's pubkey.

  12. **Fix `get_latest()`**: When `pubkey_z32` is `Some(pk)`, the URL should be `/pub/cclink/latest` (NOT `/{pk}/pub/cclink/latest`). The tenant is identified by the Host header. Pass the `pubkey_z32` parameter through to `get_bytes`.

  13. **Update all unit tests** in the `tests` module that call `HomeserverClient::new("pubky.app")` to provide a second argument. Use `fixed_keypair().public_key().to_z32()` or a hardcoded z32 string where appropriate.

  NOTE: The `pubky-host` header can be used as a fallback, but prefer the standard `Host` header. The homeserver checks `Host` first, then falls back to `pubky-host`. Using `Host` is sufficient.
  </action>
  <verify>
  Run `cargo build` — must compile with zero errors.
  Run `cargo test --lib transport::tests` — all existing unit tests pass with the updated constructor signature.
  Grep for all `.send()` calls in transport/mod.rs and verify each is preceded by a `.header("Host", ...)` call.
  </verify>
  <done>
  Every HTTP method on HomeserverClient includes a Host header with the appropriate z32 pubkey. Cross-user GET methods use the target pubkey in the Host header instead of embedding it in the URL path. The constructor requires a pubkey_z32 parameter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add signup fallback when signin returns 404</name>
  <files>src/transport/mod.rs</files>
  <action>
  Modify `signin()` to handle first-time users by falling back to POST /signup when POST /session returns 404:

  1. **In `signin()`**, after the POST `/session` request, check if the response status is 404. If so:
     - Build the same auth token bytes (reuse the `token_bytes` already computed)
     - POST to `/signup` with the same body and Host header
     - If /signup returns 409 (Conflict — user already exists), this is a race condition; retry /session once
     - If /signup succeeds (2xx), set `signed_in` flag and return Ok
     - If /signup fails with any other status, return the error

  2. The flow should be:
     ```
     POST /session → success? → done (set signed_in)
     POST /session → 404? → POST /signup → success? → done (set signed_in)
     POST /session → 404? → POST /signup → 409? → POST /session (retry once)
     POST /session → other error? → bail
     ```

  3. The Host header must be included on both /session and /signup requests.

  4. Add a unit test `test_signin_url_construction` that verifies the expected URL format (cannot test actual network, but can verify the URL string construction).

  5. Update the doc comment on `signin()` to document the session-then-signup fallback behavior.
  </action>
  <verify>
  Run `cargo build` — must compile with zero errors.
  Run `cargo test --lib transport::tests` — all tests pass.
  Read the signin() method and confirm: (1) POST /session attempted first, (2) 404 triggers POST /signup, (3) Host header present on both requests.
  </verify>
  <done>
  First-time users (who get 404 from POST /session) are automatically signed up via POST /signup. The signup fallback is transparent to callers — they just call signin() and it works for both new and existing users.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update all callers of HomeserverClient::new to pass pubkey_z32</name>
  <files>src/transport/mod.rs</files>
  <action>
  The callers of `HomeserverClient::new()` are in the command modules (publish.rs, pickup.rs, list.rs, revoke.rs). However, these files are NOT modified by this plan — they will be updated in Plan 02 since they require coordination with list parsing changes.

  Instead, this task focuses on ensuring the transport module's public API is correct and self-consistent:

  1. **Verify `publish()` method** — already uses `self.pubkey_z32` for Host header (from Task 1). No changes needed.

  2. **Verify `get_all_records()` method** — calls `list_record_tokens()` and `get_record()`, both of which now include the Host header. No changes needed.

  3. **Update the ignored integration test** `test_integration_signin_put_get` to:
     - Pass `keypair.public_key().to_z32()` as the second argument to `HomeserverClient::new`
     - This test already uses `#[ignore]` and requires a live homeserver, so the API update is all that's needed

  4. **Add a new ignored integration test** `test_integration_signup_new_keypair` that:
     - Creates a brand-new random keypair
     - Constructs HomeserverClient with the new keypair's z32
     - Calls `signin()` — which should trigger the signup fallback
     - Publishes a record and retrieves it
     - Verifies the round-trip works for a first-time user
     - Mark with `#[ignore]` (requires live homeserver)

  5. **Add a new ignored integration test** `test_integration_cross_user_get` that:
     - Creates two random keypairs (user_a and user_b)
     - user_a publishes a record (self-encrypted)
     - user_b retrieves user_a's record via `get_record_by_pubkey` with user_a's z32
     - Verifies the record metadata matches (cannot decrypt since it's self-encrypted, but can verify it was retrieved without error)
     - Mark with `#[ignore]` (requires live homeserver)
  </action>
  <verify>
  Run `cargo build` — must compile with zero errors and zero warnings.
  Run `cargo test --lib transport::tests` — all unit tests pass.
  Verify the integration tests exist and compile (but don't run them without `--ignored`).
  </verify>
  <done>
  The transport module's public API is complete and consistent. Integration tests cover signup flow and cross-user GET via Host header. All existing unit tests pass with the new constructor.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` compiles with zero errors and zero warnings
2. `cargo test --lib transport::tests` — all unit tests pass
3. Every `.send()` call in transport/mod.rs is preceded by `.header("Host", ...)`
4. `signin()` contains a 404 check and `/signup` fallback path
5. `get_record_by_pubkey()` no longer embeds pubkey in URL path — uses Host header instead
6. `get_latest()` with `Some(pubkey)` uses Host header instead of path-based routing
7. `HomeserverClient::new()` requires a `pubkey_z32` parameter
</verification>

<success_criteria>
The transport module correctly implements Pubky homeserver virtual hosting: Host header on all requests, signup/session fallback for first-time users, and Host-header-based cross-user record retrieval. All unit tests pass and integration tests are ready for live verification.
</success_criteria>

<output>
After completion, create `.planning/phases/10-pubky-homeserver-transport-fix/10-01-SUMMARY.md`
</output>
