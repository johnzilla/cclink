---
phase: 08-cli-fixes-and-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli.rs
  - src/commands/publish.rs
  - cclink-prd.md
autonomous: true
requirements:
  - FUNC-01
  - FUNC-02
  - DOCS-01

must_haves:
  truths:
    - "Running cclink --burn --share <pubkey> immediately errors with a clear message before any network call"
    - "Self-publish success message shows 'cclink pickup' as the retrieval command, not a raw token"
    - "The PRD contains no references to ~/.cclink/ paths — all key storage references say ~/.pubky/"
  artifacts:
    - path: "src/cli.rs"
      provides: "Clap conflicts_with annotation on --burn preventing --burn + --share"
      contains: "conflicts_with"
    - path: "src/commands/publish.rs"
      provides: "Self-publish success message showing cclink pickup"
      contains: "cclink pickup"
    - path: "cclink-prd.md"
      provides: "PRD with corrected key storage paths"
      contains: "~/.pubky/"
  key_links:
    - from: "src/cli.rs"
      to: "clap argument parsing"
      via: "conflicts_with attribute on burn flag"
      pattern: "conflicts_with.*=.*\"share\""
---

<objective>
Fix CLI flag validation, correct the self-publish help text, and update stale PRD paths.

Purpose: The CLI surface must be honest — invalid flag combos rejected at parse time, success messages guide users to the correct command, and documentation reflects actual filesystem layout.
Output: Three targeted fixes across cli.rs, publish.rs, and the PRD.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/cli.rs
@src/commands/publish.rs
@cclink-prd.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --burn / --share mutual exclusion in clap</name>
  <files>src/cli.rs</files>
  <action>
Add `conflicts_with = "share"` to the `#[arg]` attribute on the `burn` field in the `Cli` struct. This uses clap's built-in conflict detection so `cclink --burn --share <pubkey>` is rejected at parse time with a clear error message before any code executes.

Specifically, change the `burn` field's attribute from:
```rust
#[arg(long)]
pub burn: bool,
```
to:
```rust
#[arg(long, conflicts_with = "share")]
pub burn: bool,
```

This ensures clap itself prints: `error: the argument '--burn' cannot be used with '--share <PUBKEY>'` and exits with code 2 before main() dispatches to publish.

Do NOT add any runtime validation in main.rs or publish.rs — clap handles this entirely at parse time.
  </action>
  <verify>
Run `cargo build` to confirm compilation. Then run `./target/debug/cclink --burn --share abc123xyz` and verify it exits with a clap error message mentioning both `--burn` and `--share` without any network call or panic. Also verify `cclink --burn` alone and `cclink --share <key>` alone still work (they'll fail on missing keypair, but they should get past argument parsing).
  </verify>
  <done>
`cclink --burn --share <pubkey>` immediately exits with a clear clap conflict error. Neither flag alone triggers the conflict. No runtime validation code added — clap handles it entirely.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix self-publish success message to show cclink pickup</name>
  <files>src/commands/publish.rs</files>
  <action>
In `src/commands/publish.rs`, the self-publish success block (the `else` branch around line 147) currently prints:

```rust
println!("  Run on another machine:");
println!(
    "  {}",
    format!("cclink pickup {}", token).if_supports_color(Stdout, |t| t.bold())
);
```

This shows a raw timestamp token. For self-pickup, the user runs `cclink pickup` (no arguments) because it resolves via the `latest` pointer. Change the self-publish success message to:

```rust
println!("  Run on another machine:");
println!(
    "  {}",
    "cclink pickup".if_supports_color(Stdout, |t| t.bold())
);
```

Remove the `token` interpolation from the self-publish message. The `token` variable is still used by the QR code block below (line 161) — leave that as-is since QR needs a concrete identifier.

Do NOT change the shared-publish branch (the `if cli.share.is_some()` block) — that correctly shows `cclink pickup <pubkey>`.
  </action>
  <verify>
Run `cargo build` to confirm compilation. Read the updated publish.rs to verify the self-publish branch prints `"cclink pickup"` without a token, while the shared branch still prints `"cclink pickup {pubkey}"`. The QR code section should still reference `token`.
  </verify>
  <done>
Self-publish success message shows `cclink pickup` (no token). Shared-publish still shows `cclink pickup <pubkey>`. QR code still uses the token.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PRD key storage paths from ~/.cclink/ to ~/.pubky/</name>
  <files>cclink-prd.md</files>
  <action>
Replace the two stale `~/.cclink/keys` references in `cclink-prd.md` with `~/.pubky/`:

1. Line 148 (Phase 1 deliverables): Change `~/.cclink/keys` to `~/.pubky/secret_key`. The full line should read:
   `- [ ] Keypair generation and storage in ~/.pubky/secret_key (or reuse existing PKARR key with --import)`
   Remove the backtick formatting around the path if present — match surrounding style.

2. Line 213 (Security Model / Key compromise): Change `~/.cclink/keys` to `~/.pubky/secret_key`. The full line should read:
   `| Key compromise | Standard Ed25519 key hygiene; keys stored in ~/.pubky/secret_key with 0600 perms |`

After replacement, verify no remaining `~/.cclink` references exist in the file using grep.

Do NOT change other stale references in the PRD (like `~/.claude/sessions/` which should be `~/.claude/projects/`) — those are outside DOCS-01 scope and the PRD is a historical planning document, not active documentation.
  </action>
  <verify>
Run `grep -n '~/.cclink' cclink-prd.md` — should return zero results. Run `grep -n '~/.pubky' cclink-prd.md` — should show the two updated lines.
  </verify>
  <done>
PRD contains zero references to `~/.cclink/` paths. Both key storage references now say `~/.pubky/secret_key`.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero warnings
2. `./target/debug/cclink --burn --share abc123` exits with clap conflict error (no network call, no panic)
3. `grep -c '~/.cclink' cclink-prd.md` returns 0
4. `grep 'cclink pickup' src/commands/publish.rs` shows self-publish branch without token interpolation
</verification>

<success_criteria>
- --burn and --share are mutually exclusive at clap parse time
- Self-publish success message shows `cclink pickup` (not `cclink pickup <token>`)
- PRD has zero `~/.cclink/` path references; key storage references say `~/.pubky/secret_key`
- All three phase 8 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-cli-fixes-and-documentation/08-01-SUMMARY.md`
</output>
