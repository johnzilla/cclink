---
phase: 14-memory-zeroization
plan: 02
type: execute
wave: 2
depends_on:
  - 14-01
files_modified:
  - src/commands/publish.rs
  - src/commands/pickup.rs
autonomous: true
requirements:
  - ZERO-03

must_haves:
  truths:
    - "PIN string from dialoguer::Password::interact() in publish.rs is wrapped in Zeroizing<String> and zeroed on drop"
    - "PIN string from dialoguer::Password::interact() in pickup.rs is wrapped in Zeroizing<String> and zeroed on drop"
    - "Wrapped PIN strings auto-deref to &str for all downstream usage (validate_pin, pin_encrypt, pin_decrypt)"
  artifacts:
    - path: "src/commands/publish.rs"
      provides: "Zeroizing-wrapped PIN at the dialoguer prompt site"
      contains: "Zeroizing::new"
    - path: "src/commands/pickup.rs"
      provides: "Zeroizing-wrapped PIN at the dialoguer prompt site"
      contains: "Zeroizing::new"
  key_links:
    - from: "src/commands/publish.rs"
      to: "crate::crypto::pin_encrypt"
      via: "Zeroizing<String> auto-derefs to &str for pin_encrypt(&payload_bytes, &pin)"
      pattern: "pin_encrypt.*&pin"
    - from: "src/commands/publish.rs"
      to: "validate_pin"
      via: "Zeroizing<String> auto-derefs to &str for validate_pin(&pin)"
      pattern: "validate_pin\\(&pin\\)"
    - from: "src/commands/pickup.rs"
      to: "crate::crypto::pin_decrypt"
      via: "Zeroizing<String> auto-derefs to &str for pin_decrypt(&ciphertext, &pin, &salt)"
      pattern: "pin_decrypt.*&pin"
---

<objective>
Wrap all `dialoguer::Password::interact()` results in `Zeroizing<String>` at the call site in publish.rs and pickup.rs.

Purpose: Ensure PIN strings collected from user prompts are automatically zeroed from memory when they go out of scope (ZERO-03), preventing sensitive user input from persisting on the heap after the cryptographic operation completes.

Output: Both PIN prompt sites use `Zeroizing::new(...)` wrapping, all downstream usage compiles via `Deref<Target=String>` auto-deref to `&str`, `cargo test` passes.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-memory-zeroization/14-RESEARCH.md
@.planning/phases/14-memory-zeroization/14-01-SUMMARY.md
@src/commands/publish.rs
@src/commands/pickup.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap PIN prompts in Zeroizing in publish.rs and pickup.rs</name>
  <files>src/commands/publish.rs, src/commands/pickup.rs</files>
  <action>
1. In `src/commands/publish.rs`:
   - Add `use zeroize::Zeroizing;` to the imports at the top of the file.
   - Find the PIN prompt (line ~154): `let pin = dialoguer::Password::new()...interact()...?;`
   - Wrap in Zeroizing:
     ```rust
     let pin = Zeroizing::new(
         dialoguer::Password::new()
             .with_prompt("Enter PIN for this handoff")
             .with_confirmation("Confirm PIN", "PINs don't match")
             .interact()
             .map_err(|e| anyhow::anyhow!("PIN prompt failed: {}", e))?
     );
     ```
   - All downstream usage auto-derefs: `validate_pin(&pin)` takes `&str` (via Deref&lt;Target=String&gt; then Deref&lt;Target=str&gt;), `pin_encrypt(&payload_bytes, &pin)` takes `&str` the same way.

2. In `src/commands/pickup.rs`:
   - Add `use zeroize::Zeroizing;` to the imports at the top of the file.
   - Find the PIN prompt (line ~137): `let pin = dialoguer::Password::new()...interact()...?;`
   - Wrap in Zeroizing:
     ```rust
     let pin = Zeroizing::new(
         dialoguer::Password::new()
             .with_prompt("Enter PIN")
             .interact()
             .map_err(|e| anyhow::anyhow!("PIN prompt failed: {}", e))?
     );
     ```
   - Downstream usage auto-derefs: `pin_decrypt(&ciphertext, &pin, &salt)` takes `&str`.

3. IMPORTANT: Do NOT shadow the pin variable after wrapping (e.g., `let pin = pin.trim()` would create an unprotected `&str` borrow that is fine, but `let pin = pin.trim().to_string()` would create an unprotected String copy). The current code does not trim the PIN, so no shadowing concern exists.

4. Verify both files compile and all existing tests pass.
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && cargo test 2>&1 && cargo clippy --all-targets -- -D warnings 2>&1</automated>
    <manual>Confirm both dialoguer::Password sites are wrapped in Zeroizing::new()</manual>
  </verify>
  <done>Both PIN prompt sites in publish.rs and pickup.rs wrap dialoguer::Password::interact() results in Zeroizing::new(), all downstream usage compiles via auto-deref, cargo test passes, clippy is clean</done>
</task>

</tasks>

<verification>
```bash
# Full test suite
cargo test

# Clippy clean
cargo clippy --all-targets -- -D warnings

# Confirm Zeroizing wrapping at both prompt sites
grep -A3 'Zeroizing::new' src/commands/publish.rs
grep -A3 'Zeroizing::new' src/commands/pickup.rs

# Confirm no bare dialoguer::Password::interact() calls remain
grep -n 'dialoguer::Password' src/commands/publish.rs src/commands/pickup.rs
```
</verification>

<success_criteria>
- `cargo test` passes with zero failures
- `cargo clippy --all-targets -- -D warnings` exits 0
- `src/commands/publish.rs` contains `Zeroizing::new(` wrapping the dialoguer PIN prompt
- `src/commands/pickup.rs` contains `Zeroizing::new(` wrapping the dialoguer PIN prompt
- No bare `dialoguer::Password::new()...interact()?` calls remain (all wrapped in Zeroizing)
- `use zeroize::Zeroizing;` is present in both files
</success_criteria>

<output>
After completion, create `.planning/phases/14-memory-zeroization/14-02-SUMMARY.md`
</output>
