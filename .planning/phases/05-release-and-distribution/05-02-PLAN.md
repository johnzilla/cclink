---
phase: 05-release-and-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - .github/workflows/ci.yml
  - .github/workflows/release.yml
  - install.sh
autonomous: true
requirements: []

must_haves:
  truths:
    - "CI workflow runs cargo test on every push and pull request"
    - "Release workflow triggers only on v* tag push"
    - "Release workflow builds Linux x86_64-musl, Linux aarch64-musl, macOS universal, and Windows x86_64 binaries"
    - "Release artifacts use human-readable names: cclink-linux-x86_64, cclink-linux-aarch64, cclink-darwin-universal, cclink-windows-x86_64"
    - "SHA256 checksums are generated alongside each binary"
    - "Release workflow verifies Cargo.toml version matches the git tag before building"
    - "Installer script auto-detects platform and downloads the correct binary"
    - "Installer verifies SHA256 checksum before installing"
    - "Installer tries ~/.local/bin first, falls back to /usr/local/bin with sudo"
    - "Cargo.toml has description, license, repository, homepage for crates.io publishing"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI test workflow for every push/PR"
      min_lines: 15
    - path: ".github/workflows/release.yml"
      provides: "Tag-triggered release workflow with multi-platform builds"
      min_lines: 50
    - path: "install.sh"
      provides: "POSIX sh curl installer with platform detection and SHA256 verification"
      min_lines: 40
    - path: "Cargo.toml"
      provides: "crates.io metadata fields"
      contains: "description"
  key_links:
    - from: "install.sh"
      to: ".github/workflows/release.yml"
      via: "artifact naming convention"
      pattern: "cclink-(linux|darwin|windows)"
    - from: ".github/workflows/release.yml"
      to: "Cargo.toml"
      via: "version check step"
      pattern: "GITHUB_REF_NAME|Cargo.toml"
---

<objective>
Create CI/CD pipelines, a curl installer, and prepare Cargo.toml for crates.io publication.

Purpose: Automates testing on every push, produces multi-platform release binaries on tag push, and provides a one-liner install experience for end users.

Output: `.github/workflows/ci.yml`, `.github/workflows/release.yml`, `install.sh`, updated `Cargo.toml`
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-release-and-distribution/05-RESEARCH.md
@.planning/phases/05-release-and-distribution/05-CONTEXT.md
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Cargo.toml crates.io metadata and create CI test workflow</name>
  <files>Cargo.toml, .github/workflows/ci.yml</files>
  <action>
1. Update `Cargo.toml` `[package]` section with crates.io-required metadata:
   - `description = "Secure session handoff between devices via Pubky"` (or similar concise description)
   - `license = "MIT"` (standard for CLI tools; if user prefers different, they can change)
   - `repository = "https://github.com/user/cclink"` (placeholder — user will fill in actual repo URL)
   - `homepage = "https://github.com/user/cclink"` (same as repository for now)
   - `readme = "README.md"`
   - `keywords = ["session", "handoff", "encryption", "pubky", "cli"]`
   - `categories = ["command-line-utilities"]`

   Do NOT change the existing `version = "0.1.0"` — the user will bump it before first release tag.

2. Create `.github/workflows/ci.yml`:
   ```yaml
   name: CI
   on:
     push:
       branches: ["*"]
     pull_request:
       branches: ["*"]
   jobs:
     test:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: dtolnay/rust-toolchain@stable
         - uses: Swatinem/rust-cache@v2
         - run: cargo test --locked
         - name: Verify no OpenSSL dependency
           run: |
             cargo tree 2>/dev/null | grep -i openssl && echo "ERROR: OpenSSL found in dependency tree" && exit 1 || echo "OK: No OpenSSL dependency"
   ```

   The OpenSSL check prevents accidentally adding a dependency that would break musl builds.
  </action>
  <verify>
  - `grep -q 'description' Cargo.toml` succeeds
  - `cat .github/workflows/ci.yml` shows valid YAML with `cargo test --locked`
  </verify>
  <done>Cargo.toml has crates.io metadata fields; CI workflow runs tests on every push and PR with Rust cache and OpenSSL guard</done>
</task>

<task type="auto">
  <name>Task 2: Create release workflow with multi-platform builds and version check</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with the following structure:

```yaml
name: Release
on:
  push:
    tags: ["v[0-9]*"]
```

**Job 1: `create-release`**
- runs-on: ubuntu-latest
- Steps:
  - actions/checkout@v4
  - Verify Cargo.toml version matches tag: extract tag version via `${GITHUB_REF_NAME#v}`, extract Cargo.toml version via `grep '^version' Cargo.toml | head -1 | sed 's/.*= *"\(.*\)"/\1/'`, compare, fail if mismatch
  - `taiki-e/create-gh-release-action@v1` with `token: ${{ secrets.GITHUB_TOKEN }}`. Omit the `changelog` field (use GitHub auto-generated release notes instead)

**Job 2: `upload-assets`**
- needs: create-release
- strategy.matrix.include with these entries (per user decision on artifact naming):
  ```yaml
  - target: x86_64-unknown-linux-musl
    os: ubuntu-latest
    artifact_name: cclink-linux-x86_64
  - target: aarch64-unknown-linux-musl
    os: ubuntu-latest
    artifact_name: cclink-linux-aarch64
  - target: universal-apple-darwin
    os: macos-latest
    artifact_name: cclink-darwin-universal
  - target: x86_64-pc-windows-msvc
    os: windows-latest
    artifact_name: cclink-windows-x86_64
  ```
- runs-on: ${{ matrix.os }}
- Steps:
  - actions/checkout@v4
  - `taiki-e/upload-rust-binary-action@v1` with:
    - `bin: cclink`
    - `target: ${{ matrix.target }}`
    - `archive: ${{ matrix.artifact_name }}`
    - `checksum: sha256`
    - `token: ${{ secrets.GITHUB_TOKEN }}`

**Job 3: `publish-crates-io`**
- needs: upload-assets
- runs-on: ubuntu-latest
- permissions: { id-token: write } (for Trusted Publishing OIDC)
- Steps:
  - actions/checkout@v4
  - dtolnay/rust-toolchain@stable
  - `run: cargo publish`
  - Add a comment in the YAML: `# First publish requires CARGO_REGISTRY_TOKEN secret or manual 'cargo publish'. After that, configure Trusted Publishing on crates.io for OIDC-based auth.`

CRITICAL artifact naming: Use `archive: ${{ matrix.artifact_name }}` with the matrix `artifact_name` field to get human-readable names (`cclink-linux-x86_64`) instead of Rust target triples. The SHA256 checksum files will also use these names.

Do NOT run `cargo test` for cross-compiled targets in the release job — tests run in the CI workflow on every push. The release job only builds.
  </action>
  <verify>`cat .github/workflows/release.yml` shows valid YAML with 3 jobs, version check, 4 build matrix entries with human-readable artifact names, and SHA256 checksums</verify>
  <done>Release workflow creates GitHub Release on v* tag push, builds 4 platform binaries with human-readable names, generates SHA256 checksums, and publishes to crates.io</done>
</task>

<task type="auto">
  <name>Task 3: Create POSIX sh installer script with platform detection and SHA256 verification</name>
  <files>install.sh</files>
  <action>
Create `install.sh` at the repository root as a POSIX sh script (NOT bash).

**Script structure:**

1. **Shebang and safety:** `#!/bin/sh` + `set -eu`

2. **Configuration:**
   - `REPO="user/cclink"` (placeholder — user fills in actual GitHub user/org)
   - `BINARY="cclink"`
   - `VERSION="${CCLINK_VERSION:-latest}"` (allow version override via env)

3. **Platform detection:**
   - `OS=$(uname -s | tr '[:upper:]' '[:lower:]')`
   - `ARCH=$(uname -m)`
   - Map OS: `linux` -> `linux`, `darwin` -> `darwin`, else error with "Unsupported OS"
   - Map ARCH: `x86_64` -> `x86_64`, `aarch64`/`arm64` -> `aarch64`, else error with "Unsupported architecture"
   - macOS override: if `darwin`, set `ARTIFACT="cclink-darwin-universal"` (universal binary covers all archs)
   - Linux/other: `ARTIFACT="cclink-${OS_NAME}-${ARCH_NAME}"`

4. **Version resolution:**
   - If `VERSION` is "latest": use GitHub API to resolve latest tag: `curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name"' | sed 's/.*"tag_name": *"\([^"]*\)".*/\1/'`
   - Construct download base URL: `https://github.com/${REPO}/releases/download/${VERSION}`

5. **Download binary and checksum:**
   - Determine archive extension: `.tar.gz` for Linux/macOS, `.zip` for Windows (but this installer is POSIX sh — Windows users use other methods, so only handle tar.gz)
   - Download: `curl -fsSL -o "${ARTIFACT}.tar.gz" "${BASE_URL}/${ARTIFACT}.tar.gz"`
   - Download checksum: `curl -fsSL -o "${ARTIFACT}.tar.gz.sha256" "${BASE_URL}/${ARTIFACT}.tar.gz.sha256"`

6. **SHA256 verification:**
   - Cross-platform SHA256: try `sha256sum` first, fall back to `shasum -a 256`
   - Verify: `echo "$EXPECTED_SHA256  ${ARTIFACT}.tar.gz" | sha256sum --check --quiet` or equivalent
   - Read expected hash from the `.sha256` file: `EXPECTED=$(awk '{print $1}' "${ARTIFACT}.tar.gz.sha256")`
   - If neither sha256sum nor shasum available, print warning but continue

7. **Extract and install:**
   - `tar xzf "${ARTIFACT}.tar.gz"`
   - Determine install directory:
     - First try: `INSTALL_DIR="$HOME/.local/bin"` — create with `mkdir -p` if needed
     - Copy binary: `cp cclink "$INSTALL_DIR/cclink"` + `chmod +x "$INSTALL_DIR/cclink"`
   - Check if `$INSTALL_DIR` is in `$PATH` — if not, print a note telling user to add it

8. **Cleanup:** Remove downloaded archive and checksum file

9. **Success message:** Print installed version and path

Make the script executable-ready. Add a comment header explaining usage:
```
# Usage: curl -fsSL https://raw.githubusercontent.com/user/cclink/main/install.sh | sh
# Override version: CCLINK_VERSION=v1.0.0 sh install.sh
```

Use `printf` instead of `echo` for portability (POSIX sh `echo` behavior varies).
  </action>
  <verify>
  - `sh -n install.sh` passes (valid POSIX sh syntax)
  - Script begins with `#!/bin/sh` and `set -eu`
  - Script contains platform detection for linux/darwin
  - Script contains SHA256 verification logic
  - Script contains `~/.local/bin` install path with PATH check
  </verify>
  <done>POSIX sh installer script auto-detects platform, downloads correct binary, verifies SHA256 checksum, and installs to ~/.local/bin with PATH guidance</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` is valid YAML and contains `cargo test --locked`
2. `.github/workflows/release.yml` is valid YAML with version check, 4 matrix targets, human-readable artifact names, SHA256 checksums
3. `install.sh` passes `sh -n` syntax check
4. `Cargo.toml` contains `description`, `license`, `repository`, `keywords`, `categories`
5. Artifact names in `install.sh` match artifact names in `release.yml` (`cclink-linux-x86_64`, `cclink-linux-aarch64`, `cclink-darwin-universal`)
</verification>

<success_criteria>
- CI workflow ready to run on push/PR (cargo test + OpenSSL guard)
- Release workflow ready to trigger on v* tag (version check + 4 platform builds + checksums + crates.io publish)
- Installer script is syntactically valid POSIX sh with platform detection, SHA256 verification, and ~/.local/bin install
- Cargo.toml is ready for crates.io publication (has all required metadata fields)
</success_criteria>

<output>
After completion, create `.planning/phases/05-release-and-distribution/05-02-SUMMARY.md`
</output>
