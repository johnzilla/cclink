---
phase: 12-ci-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/ci.yml]
autonomous: true
requirements: [CI-02, CI-03, CI-04]

must_haves:
  truths:
    - "CI runs a `lint` job with `cargo clippy --all-targets -- -D warnings` and `cargo fmt --check` on every push and PR"
    - "CI runs an `audit` job with `actions-rust-lang/audit@v1` on every push and PR"
    - "A clippy warning causes the `lint` job to fail while the `test` job remains unaffected"
    - "Lint and audit jobs run in parallel with the existing test job (no `needs:` dependencies between them)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with test, lint, and audit jobs"
      contains: "lint:"
  key_links:
    - from: ".github/workflows/ci.yml lint job"
      to: "cargo clippy and cargo fmt"
      via: "run: steps in lint job"
      pattern: "cargo clippy --all-targets -- -D warnings"
    - from: ".github/workflows/ci.yml audit job"
      to: "actions-rust-lang/audit@v1"
      via: "uses: step in audit job"
      pattern: "actions-rust-lang/audit@v1"
---

<objective>
Add lint and audit CI jobs to the GitHub Actions workflow so every push and PR runs clippy, rustfmt, and cargo-audit as independent parallel jobs alongside the existing test job.

Purpose: Enforce code quality gates automatically -- clippy warnings, format drift, and security advisories are caught before merge. Phase 11 ensured all gates pass locally; this phase makes them enforceable.
Output: Updated `.github/workflows/ci.yml` with three parallel jobs: `test` (existing), `lint` (new), `audit` (new).
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-hardening/12-RESEARCH.md
@.planning/phases/11-prerequisites/11-01-SUMMARY.md
@.planning/phases/11-prerequisites/11-02-SUMMARY.md
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lint and audit jobs to CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Replace the contents of `.github/workflows/ci.yml` with three independent parallel jobs. Keep the existing `test` job UNCHANGED. Add two new top-level jobs:

**`lint` job (satisfies CI-02 and CI-04):**
- `runs-on: ubuntu-latest`
- Step 1: `actions/checkout@v4`
- Step 2: `dtolnay/rust-toolchain@stable` with `components: clippy, rustfmt` (explicit component declaration -- do NOT omit even though stable includes them by default)
- Step 3: `Swatinem/rust-cache@v2` (speeds up compilation for clippy)
- Step 4: `run: cargo clippy --all-targets -- -D warnings`
- Step 5: `run: cargo fmt --check` (MUST use `--check` flag -- without it fmt silently reformats and always passes)

**`audit` job (satisfies CI-03):**
- `runs-on: ubuntu-latest`
- `permissions:` block with `contents: read` and `issues: write` (issues: write enables auto-issue-creation for advisories on main branch pushes; without it the job errors on main)
- Step 1: `actions/checkout@v4`
- Step 2: `uses: actions-rust-lang/audit@v1` (do NOT add dtolnay/rust-toolchain -- the audit action ships with cargo-audit pre-bundled and does not need Rust installed)

**Critical constraints:**
- Do NOT add any `needs:` relationships between jobs -- they must run in parallel (GitHub Actions runs top-level jobs concurrently by default when no `needs:` is specified)
- Do NOT use deprecated `actions-rs/*` actions (unmaintained since ~2022)
- Do NOT add `Swatinem/rust-cache@v2` to the `audit` job (it does not compile code, cache is unnecessary)
- Keep the job name exactly `lint` (not `check` or `clippy`) to match the phase success criteria
- Keep the same `on:` triggers as the existing workflow: `push: branches: ["*"]` and `pull_request: branches: ["*"]`
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && python3 -c "
import yaml, sys
with open('.github/workflows/ci.yml') as f:
    ci = yaml.safe_load(f)
jobs = ci.get('jobs', {})
assert 'test' in jobs, 'missing test job'
assert 'lint' in jobs, 'missing lint job'
assert 'audit' in jobs, 'missing audit job'
# Verify no needs: dependencies between the three
for name in ['test', 'lint', 'audit']:
    needs = jobs[name].get('needs')
    assert needs is None, f'{name} has needs: {needs} -- jobs must be parallel'
# Verify lint steps contain clippy and fmt
lint_steps = [s.get('run','') for s in jobs['lint'].get('steps',[]) if 'run' in s]
assert any('cargo clippy --all-targets -- -D warnings' in s for s in lint_steps), 'lint missing clippy command'
assert any('cargo fmt --check' in s for s in lint_steps), 'lint missing fmt --check'
# Verify audit uses the correct action
audit_steps = [s.get('uses','') for s in jobs['audit'].get('steps',[]) if 'uses' in s]
assert any('actions-rust-lang/audit@v1' in s for s in audit_steps), 'audit missing actions-rust-lang/audit@v1'
print('ALL CI STRUCTURE CHECKS PASSED')
" 2>&1 && echo "VERIFY: PASS" || echo "VERIFY: FAIL"</automated>
    <manual>Review ci.yml in editor -- three jobs, no needs: links, correct action versions</manual>
  </verify>
  <done>
    `.github/workflows/ci.yml` contains three top-level jobs (`test`, `lint`, `audit`) with no `needs:` dependencies. The `lint` job runs `cargo clippy --all-targets -- -D warnings` and `cargo fmt --check`. The `audit` job uses `actions-rust-lang/audit@v1` with `permissions: contents: read, issues: write`. The existing `test` job is unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate CI gates pass locally and YAML is well-formed</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Run all three CI gate commands locally to confirm they still pass (Phase 11 ensured this, but validate after any file changes):

1. `cargo clippy --all-targets -- -D warnings` -- must exit 0
2. `cargo fmt --check` -- must exit 0
3. `cargo audit` -- must exit 0

Also validate the YAML is syntactically correct by parsing it:
4. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` -- must not throw

If any gate fails, investigate and fix before proceeding. Phase 11 already fixed all known issues, so failures here indicate a regression.

**Do NOT push to remote or trigger a CI run** -- that is the user's decision.
  </action>
  <verify>
    <automated>cd /home/john/vault/projects/github.com/cclink && cargo clippy --all-targets -- -D warnings 2>&1 && cargo fmt --check 2>&1 && cargo audit 2>&1 && python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('YAML VALID')" && echo "ALL GATES PASS" || echo "GATE FAILURE"</automated>
  </verify>
  <done>
    All three CI gate commands exit 0 locally: clippy clean, fmt clean, audit clean. The ci.yml file is valid YAML. The workflow is ready for the next push to trigger all three parallel CI jobs.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` has exactly three jobs: `test`, `lint`, `audit`
2. No job has a `needs:` key referencing another of the three jobs
3. `lint` job steps include `cargo clippy --all-targets -- -D warnings` and `cargo fmt --check`
4. `audit` job uses `actions-rust-lang/audit@v1` with explicit `permissions` block
5. `cargo clippy --all-targets -- -D warnings` exits 0 locally
6. `cargo fmt --check` exits 0 locally
7. `cargo audit` exits 0 locally
</verification>

<success_criteria>
- CI workflow file contains `lint` and `audit` jobs running in parallel with `test`
- Clippy, fmt, and audit enforcement commands are correctly specified
- All three gates pass locally (no day-one CI failures)
- YAML is syntactically valid
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-hardening/12-01-SUMMARY.md`
</output>
